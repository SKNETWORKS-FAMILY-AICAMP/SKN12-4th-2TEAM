    <!DOCTYPE html>
    <html lang="ko">
    <head>
    <meta charset="UTF-8">
    <title>ESG Chatbot - Ï±óÎ¥á</title>
    <link rel="stylesheet" href="/common/styles/reset.css">
    <link rel="stylesheet" href="/common/styles/theme.css">
    <link rel="stylesheet" href="/common/components/navbar.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
        margin: 0;
        background: #f7f7f7;
        height: 100vh;
        overflow: hidden;
        }
        #navbar {
        position: fixed;
        top: 0; left: 0; right: 0;
        z-index: 200;
        height: 100px;
        }
        .main-layout {
        display: flex;
        width: 100%;
        margin-top: 100px;
        box-sizing: border-box;
        }
        .side-panel {
        width: 320px;
        min-width: 320px;
        background: #f8f9fa;
        border-right: 1.5px solid #eee;
        padding: 12px 18px 80px 24px;
        height: calc(100vh - 60px);
        }
        .main-layout.collapsed .side-panel {
        width: 0;
        min-width: 0;
        opacity: 0;
        pointer-events: none;
        padding: 0;
        border: none;
        }
        .side-panel-content {
        height: 100%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 32px;
        }
        .guide-box {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.04);
        padding: 18px 16px;
        margin-bottom: 12px;
        font-size: 1em;
        color: #444;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        margin-left: 8px;
        margin-right: 8px;
        }
        .guide-box:last-child { margin-bottom: 0; }
        .guide-box .icon {
        font-size: 1.3em;
        margin-top: 2px;
        color: #bbb;
        }
        .example-title {
        font-weight: bold;
        color: #000;
        font-size: 1.08em;
        }
        
        .keyword-box {
        background: #ffffff;
        border-radius: 8px;
        padding: 7px 14px;
        font-size: 0.98em;
        margin-bottom: 10px;
        display: inline-block;
        }

        .keyword-box-env {
        color: #678360;
        }

        .keyword-box-sc {
        color: #718999;
        }

        .keyword-box-gv {
        color: #9D746D;
        }


        .example-category {
        font-weight: bold;
        margin-bottom: 10px;
        }

        .example-q {
        border-radius: 8px;
        padding: 10px 14px;
        margin-bottom: 8px;
        font-size: 0.98em;
        color: #222;
        cursor: pointer;
        transition: background 0.15s;
        }

        .example-env-q {
            background: #DBEBD7;
        }

        .example-sc-q {
            background: #DBE8F2;
        }

        .example-gv-q {
            background: #CDACAC;
        }
        
        .example-env-q:hover {
            color:#fff;
            background: #94BA8A;
        }

        .example-sc-q:hover {
            color:#fff;
            background: #95B1C4;
        }

        .example-gv-q:hover {
            color:#fff;
            background: #A98686;
        }
    
        .chatbot-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        height: calc(100vh - 60px);
        position: relative;
        align-items: center;
        }
        .chatbot-header,
        .chat-area,
        .chatbot-input-bar {
        width: 100%;
        margin: 0 auto;
        }
        .chatbot-header {
        display: flex;
        align-items: center;
        padding: 32px 32px 0 32px;
        font-weight: bold;
        gap: 12px;
        }
        .toggle-arrow {
        font-size: 1.5em;
        cursor: pointer;
        direction: ltr;
        transform: none !important;
        transition: none !important;
        }

        .main-layout.collapsed .toggle-arrow {
        transform: rotate(180deg);
        }
        .chatbot-header .refresh-btn {
        margin-left: auto;
        font-size: 1.2em;
        color: #444;
        background: none;
        border: none;
        cursor: pointer;
        transition: color 0.15s;
        padding: 0;
        }
        .chatbot-header .refresh-btn:hover {
        color: #46733F;
        }
        .chat-area {
        height: calc(100vh - 60px - 70px);
        overflow-y: auto;
        padding: 84px 32px 80px 32px;
        }
        .chat-bubble.user, .chat-bubble.bot {
            align-items: flex-end;
            gap: 8px;
        }
        .chat-bubble.user {
        display: flex;
        justify-content: flex-end;
        text-align: right;
        margin-bottom: 24px;
        }
        .chat-bubble.user .bubble {
        display: inline-block;
        background: #666;
        color: #fff;
        border-radius: 18px 18px 4px 18px;
        padding: 12px 20px;
        font-size: 1.1em;
        max-width: 70%;
        }
        .chat-bubble.bot {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 32px;
        }
        .chat-bubble.bot .bot-icon {
        font-size: 2em;
        margin-top: 2px;
        }
        .chat-bubble.bot .bubble {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
        font-size: 1.08em;
        color: #222;
        text-align: left;
        }
        .chat-bubble.bot .bubble hr {
        margin: 18px 0;
        border: none;
        border-top: 1px solid #ddd;
        }
        .chat-bubble.bot .bubble b {
        font-weight: bold;
        }
        .chat-feedback {
        margin: 12px 0 0 0;
        font-size: 0.98em;
        color: #888;
        display: flex;
        align-items: center;
        gap: 8px;
        }
        .chat-feedback .feedback-btn {
        background: none;
        border: none;
        color: #52B33F;
        cursor: pointer;
        font-size: 1.1em;
        margin-left: 4px;
        }
        .chat-feedback .error-msg {
        margin-left:16px; color:#e74c3c;
        }
        .chatbot-input-bar {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 40px;
        width: 100%;
        max-width: 700px;
        margin: 0 auto;
        border-top: none;
        padding: 16px 0 20px 0;
        z-index: 100;
        background: transparent;
        }
        .chatbot-input-inner {
        width: 100%;
        max-width: 1300px;
        display: flex;
        gap: 8px;
        align-items: center;
        }
        .chatbot-input-inner input {
        flex: 1;
        font-size: 1.1em;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px 18px;
        }
        .chatbot-input-inner button {
        background: #6CA368;
        color: #fff;
        border: none;
        border-radius: 8px;
        width: 50px;
        height: 50px;
        cursor: pointer;
        transition: background 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        }
        .chatbot-input-inner button svg {
            width: 24px;
            height: 24px;
        }
        .chatbot-input-inner button:disabled {
        background: #ccc;
        cursor: not-allowed;
        }
        #spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 199;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6CA368;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chat-time {
            font-size: 0.8em;
            color: #999;
            margin: 0 4px;
        }
        .bubble-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 80%;
        }
        .main-layout.collapsed .side-panel .toggle-arrow#toggle-sidebar-left {
            display: none !important;
        }
        .main-layout.collapsed .chatbot-header .toggle-arrow#toggle-sidebar-right {
            display: inline-block !important;
            margin-right: 12px;
        }
        .chatbot-header .toggle-arrow#toggle-sidebar-right {
            display: none;
        }
        /* Ï±óÎ¥á Î¶¨Ïä§Ìä∏ Îì§Ïó¨Ïì∞Í∏∞ */
        .bubble ul, .bubble ol {
          margin-left: 1.5em;
          padding-left: 1.2em;
          margin-top: 0;
        }
        .bubble h3 {
          margin-bottom: 0;
        }
    </style>
    </head>
    <body>
    <div id="navbar"></div>
    <div class="main-layout">
        <div class="side-panel">
            <div style="display: flex; justify-content: flex-end; align-items: center;">
              <span class="toggle-arrow" id="toggle-sidebar-left" style="display: block;">‚óÄ</span>
            </div>
            <div class="side-panel-content">
                <h2>Í∞ÄÏù¥ÎìúÎùºÏù∏</h2>
                <div>
                <div class="guide-box"><div style="display:flex;align-items:center;gap:8px;"><span class="icon">‚ö†Ô∏è</span><span class="example-title">ÏãúÏä§ÌÖú Ïò§Î•ò ÎåÄÏùë</span></div><div style="font-size:0.97em;color:#888;margin-top:4px;">Ï±óÎ¥áÏù¥ Ïù∏ÏãùÏ†ÅÏúºÎ°ú ÏùëÎãµÌïòÏßÄ ÏïäÏùÑ Í≤ΩÏö∞, F5 ÌÇ§Î•º ÎàåÎü¨ ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏÑ∏Ïöî.</div></div>
                <div class="guide-box"><div style="display:flex;align-items:center;gap:8px;"><span class="icon">üí°</span><span class="example-title">Ï†ÑÎ¨∏ÏÑ± ÏûàÎäî ÎãµÎ≥Ä</span></div><div style="font-size:0.97em;color:#888;margin-top:4px;">Í∏∞ÏóÖÏùò ESG Í≤ΩÏòÅ Ï†ÑÎûµÏùÑ Íµ¨Ï≤¥Ï†ÅÏù¥Í≥† Î™ÖÌôïÌïòÍ≤å ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.<br>AI Ï±óÎ¥áÏùò Ïö∞Ïàò Í∏∞ÏóÖ ÏÇ¨Î°ÄÎ•º Í∏∞Î∞òÏúºÎ°ú Ï†ÑÎûµÏùò Ï†ÅÌï©ÏÑ±Í≥º Í∞úÏÑ†Î∞©ÏïàÏùÑ Ï†úÏãúÌï©ÎãàÎã§.</div></div>
                <div class="guide-box"><div style="display:flex;align-items:center;gap:8px;"><span class="icon">üîÑ</span><span class="example-title">Ï±óÎ¥á Ïö¥ÏòÅ Î∞©Ïãù</span></div><div style="font-size:0.97em;color:#888;margin-top:4px;">Ï±óÎ¥áÍ≥ºÏùò ÎåÄÌôîÎäî ÏÑ∏ÏÖò Îã®ÏúÑÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§.<br>ÏÉàÎ°úÏö¥ ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏã† ÌõÑ, Ïö∞Ï∏° ÏÉÅÎã®Ïùò Ï¥àÍ∏∞Ìôî Î≤ÑÌäºÏùÑ ÎàåÎü¨ Î¶¨ÏÖãÌïòÏÑ∏Ïöî.</div></div>
                <div class="guide-box"><div style="display:flex;align-items:center;gap:8px;"><span class="icon">üí¨</span><span class="example-title">ÎåÄÌôî ÎÇ¥Ïó≠ Ï†ÄÏû•</span></div><div style="font-size:0.97em;color:#888;margin-top:4px;">Ï±óÎ¥áÍ≥ºÏùò Î™®Îì† ÎåÄÌôî ÎÇ¥Ïö©ÏùÄ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.<br>Ï†ÄÏû•Îêú ÎÇ¥Ïó≠ÏùÄ ÎßàÏù¥ÌéòÏù¥ÏßÄ ÎÇ¥ ÌûàÏä§ÌÜ†Î¶¨ Î©îÎâ¥ÏóêÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÏúºÎ©∞, Ï∂îÌõÑ Ïû¨Ï∞∏Ï°∞ Î∞è ÏóÖÎ¨¥ Î≥¥Í≥† Ïãú ÌôúÏö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.</div></div> 
                <div class="guide-box"><div style="display:flex;align-items:center;gap:8px;"><span class="icon">üìÇ</span><span class="example-title">Ïπ¥ÌÖåÍ≥†Î¶¨ Î∞è ÏòàÏãú ÏßàÎ¨∏ ÏïàÎÇ¥</span></div><div style="font-size:0.97em; color:#888;margin-top:4px;">Ï£ºÏöî ÏßàÎ¨∏ Ïπ¥ÌÖåÍ≥†Î¶¨ÏôÄ ÏòàÏãú Î¨∏Ìï≠ÏùÄ ÏÇ¨Ïù¥ÎìúÎ∞î ÌïòÎã®ÏóêÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.<br>Í∞Å ÏòàÏãú ÏßàÎ¨∏ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Ìï¥Îãπ Î¨∏Ïû•Ïù¥ ÏûêÎèôÏúºÎ°ú ÏûÖÎ†•ÎêòÏñ¥ Ï¶âÏãú Í≤ÄÏÉâÎê©ÎãàÎã§.</div></div>
                </div>
                <hr style="width: 60%; margin: 20px auto; border: none; border-top: 1px solid #DADADA;">
                <h2>ÏòàÏãúÏßàÎ¨∏</h2>
                <div class="example-list">
                <div class="example-category">üåç ÌôòÍ≤Ω(Environment)</div>
                <div class="keyword-box keyword-box-env"><strong>ÌÉÑÏÜåÎ∞∞Ï∂ú, Ïû¨ÏÉùÏóêÎÑàÏßÄ, ÏπúÌôòÍ≤Ω Ìè¨Ïû•, ÏóêÎÑàÏßÄ Ï†àÏïΩ</strong></div>
                    <div class="example-q example-env-q" data-question="ÎãπÏÇ¨Îäî ÏÇ¨Ïò• Ï†ÑÎ†•Ïùò 30%Î•º ÌÉúÏñëÍ¥ëÏúºÎ°ú Ï†ÑÌôòÌñàÎäîÎç∞, Ïù¥Îü∞ Ï†êÏù¥ ESG Ïö∞Ïàò Ï†ÑÎûµÏúºÎ°ú Ïù∏Ï†ïÎêòÎÇòÏöî?">ÎãπÏÇ¨Îäî ÏÇ¨Ïò• Ï†ÑÎ†•Ïùò 30%Î•º ÌÉúÏñëÍ¥ëÏúºÎ°ú Ï†ÑÌôòÌñàÎäîÎç∞, Ïù¥Îü∞ Ï†êÏù¥ ESG Ïö∞Ïàò Ï†ÑÎûµÏúºÎ°ú Ïù∏Ï†ïÎêòÎÇòÏöî?</div>
                    <div class="example-q example-env-q" data-question="ÏµúÍ∑º Ï†úÌíà Ìè¨Ïû•Ïóê ÏÇ¨Ïö©ÎêòÎäî Ïû¨ÌôúÏö© ÌîåÎùºÏä§Ìã± ÎπÑÏú®ÏùÑ 70%ÍπåÏßÄ ÌôïÎåÄÌïòÏòÄÎäîÎç∞, Í≤ΩÏüÅÏÇ¨Îì§Ïùò ÎèÑÏûÖ ÏàòÏ§ÄÏùÄ Ïñ¥Îñ§Í∞ÄÏöî?">ÏµúÍ∑º Ï†úÌíà Ìè¨Ïû•Ïóê ÏÇ¨Ïö©ÎêòÎäî Ïû¨ÌôúÏö© ÌîåÎùºÏä§Ìã± ÎπÑÏú®ÏùÑ 70%ÍπåÏßÄ ÌôïÎåÄÌïòÏòÄÎäîÎç∞, Í≤ΩÏüÅÏÇ¨Îì§Ïùò ÎèÑÏûÖ ÏàòÏ§ÄÏùÄ Ïñ¥Îñ§Í∞ÄÏöî?</div>
                </div>
                <div class="example-list">
                <div class="example-category">üë• ÏÇ¨Ìöå(Social)</div>
                <div class="keyword-box keyword-box-sc"><strong>ÏùºÌöåÏö©Ìíà Ï†ÄÍ∞ê, ÏßÄÏó≠ÏÇ¨Ìöå Ï∞∏Ïó¨, ÏßÅÏõê Î≥µÏßÄ, Îã§ÏñëÏÑ±</strong></div>
                    <div class="example-q example-sc-q" data-question="Ïò¨Ìï¥ Ïó¨ÏÑ± ÏûÑÏõê ÎπÑÏú®Ïù¥ 20% Í∞êÏÜåÌñàÎäîÎç∞, Ïù¥ Ï†êÏù¥ Îã§ÏñëÏÑ±Í≥º Í¥ÄÎ†®Ìï¥ Î∂ÄÏ†ïÏ†Å ÌèâÍ∞ÄÎ•º Î∞õÏùÑ Ïàò ÏûàÎÇòÏöî?">Ïò¨Ìï¥ Ïó¨ÏÑ± ÏûÑÏõê ÎπÑÏú®Ïù¥ 20% Í∞êÏÜåÌñàÎäîÎç∞, Ïù¥ Ï†êÏù¥ Îã§ÏñëÏÑ±Í≥º Í¥ÄÎ†®Ìï¥ Î∂ÄÏ†ïÏ†Å ÌèâÍ∞ÄÎ•º Î∞õÏùÑ Ïàò ÏûàÎÇòÏöî?</div>
                    <div class="example-q example-sc-q" data-question="ÌòëÎ†•ÏÇ¨ ÎåÄÏÉÅ ESG ÌèâÍ∞ÄÎ•º Ïó∞ 1Ìöå Ïã§ÏãúÌïòÍ≥† Í≤∞Í≥ºÎ•º Í≥µÍ∞úÌïòÎäîÎç∞, Ïù¥Îü∞ Î∞©ÏãùÏù¥ Î≥¥Ìé∏Ï†ÅÏù∏Í∞ÄÏöî?">ÌòëÎ†•ÏÇ¨ ÎåÄÏÉÅ ESG ÌèâÍ∞ÄÎ•º Ïó∞ 1Ìöå Ïã§ÏãúÌïòÍ≥† Í≤∞Í≥ºÎ•º Í≥µÍ∞úÌïòÎäîÎç∞, Ïù¥Îü∞ Î∞©ÏãùÏù¥ Î≥¥Ìé∏Ï†ÅÏù∏Í∞ÄÏöî?</div>
                </div>
                <div class="example-list">
                <div class="example-category">üóÇÔ∏è ÏßÄÎ∞∞Íµ¨Ï°∞(Governance)</div>
                <div class="keyword-box keyword-box-gv"><strong>Ïù∏ÏÇ¨ Íµ¨Ï°∞, Ïú§Î¶¨ Í≤ΩÏòÅ, ÎÇ¥Î∂ÄÍ∞êÏÇ¨, Ïù¥ÏÇ¨Ìöå Íµ¨ÏÑ±</strong></div>
                    <div class="example-q example-gv-q" data-question="ÏÇ¨ÎÇ¥ Ïú§Î¶¨Í∞ïÎ†πÏùÑ Ï†Ñ Íµ¨ÏÑ±ÏõêÏóêÍ≤å ÍµêÏú°ÌïòÍ≥† ÏÑúÏïΩÏùÑ Î∞õÎèÑÎ°ù Ïö¥ÏòÅ Ï§ëÏù∏Îç∞, Ìö®Í≥ºÏ†ÅÏù∏Í∞ÄÏöî?">ÏÇ¨ÎÇ¥ Ïú§Î¶¨Í∞ïÎ†πÏùÑ Ï†Ñ Íµ¨ÏÑ±ÏõêÏóêÍ≤å ÍµêÏú°ÌïòÍ≥† ÏÑúÏïΩÏùÑ Î∞õÎèÑÎ°ù Ïö¥ÏòÅ Ï§ëÏù∏Îç∞, Ìö®Í≥ºÏ†ÅÏù∏Í∞ÄÏöî?</div>
                    <div class="example-q example-gv-q" data-question="ÎÇ¥Î∂Ä Í≥†Î∞ú Ï†úÎèÑÍ∞Ä ÎßàÎ†®ÎêòÏñ¥ ÏûàÏßÄÎßå ÏùµÎ™ÖÏÑ±Ïù¥ Î∂ÄÏ°±ÌïòÎã§Îäî ÏßÄÏ†ÅÏùÑ Î∞õÏïòÎäîÎç∞, Í∞úÏÑ†Ìï¥Ïïº Ìï†ÍπåÏöî?">ÎÇ¥Î∂Ä Í≥†Î∞ú Ï†úÎèÑÍ∞Ä ÎßàÎ†®ÎêòÏñ¥ ÏûàÏßÄÎßå ÏùµÎ™ÖÏÑ±Ïù¥ Î∂ÄÏ°±ÌïòÎã§Îäî ÏßÄÏ†ÅÏùÑ Î∞õÏïòÎäîÎç∞, Í∞úÏÑ†Ìï¥Ïïº Ìï†ÍπåÏöî?</div>
                </div>
            </div>
        </div>
        <div class="chatbot-main">
            <div id="spinner-overlay" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div class="chatbot-header">
                <span class="toggle-arrow" id="toggle-sidebar-right" style="display: none; font-size:1.5em;">‚ñ∂</span>
                <span style="font-size:1.5em; font-weight: bold;">ESG Ï±óÎ¥á</span>
                <a href="/chatbot.html" class="refresh-btn" title="ÏÉà Ï±ÑÌåÖ ÏãúÏûë"><span style="font-size:1.5em;">&#8635;</span></a>
            </div>
            <div class="chat-area" id="chat-area">
                <!-- Ï±ÑÌåÖ ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
            <div class="chatbot-input-bar">
                <div class="chatbot-input-inner">
                <input type="text" placeholder="ESG Ï†ÑÎûµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
                <button title="Ï†ÑÏÜ°">
                    <svg viewBox="0 0 24 24" fill="currentColor" height="1em" width="1em">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
                </div>
            </div>
        </div>
    </div>
    <script src="/common/components/navbar.js"></script>
    <script>
    // API Í∏∞Î≥∏ URL (ÏÉÅÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö© - Nginx ÌîÑÎ°ùÏãúÎ•º ÌÜµÌï¥ API ÏÑúÎ≤ÑÎ°ú Ï†ÑÎã¨)
    const API_BASE = '';

    // URLÏóêÏÑú Ï±ÑÌåÖÎ∞© ID Ï∂îÏ∂ú Ìï®Ïàò
    function getRoomIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('room');
    }

    // ÌòÑÏû¨ Ï±ÑÌåÖÎ∞© ID (URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Í∞ÄÏ†∏Ïò¥)
    let roomId = getRoomIdFromUrl();

    // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å Ïãú Ïã§ÌñâÎêòÎäî Ï¥àÍ∏∞Ìôî Ìï®Ïàò
    window.addEventListener('DOMContentLoaded', async function() {
        // ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏
        // credentials: 'include'Î°ú Ïø†ÌÇ§ Í∏∞Î∞ò Ïù∏Ï¶ù ÏÇ¨Ïö©
        fetch(`${API_BASE}/auth/me`, { credentials: 'include' })
            .then(res => {
                if (!res.ok) location.href = `login.html?next=${encodeURIComponent(location.pathname + location.search)}`;
            })
            .catch(() => location.href = `login.html?next=${encodeURIComponent(location.pathname + location.search)}`);

        // ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        document.getElementById('toggle-sidebar-left').onclick = function() {
            document.querySelector('.main-layout').classList.add('collapsed');
        };
        document.getElementById('toggle-sidebar-right').onclick = function() {
            document.querySelector('.main-layout').classList.remove('collapsed');
        };

        // Í∏∞Ï°¥ Ï±ÑÌåÖÎ∞©Ïù¥ ÏûàÎäî Í≤ΩÏö∞: Î©îÏãúÏßÄ Ïù¥Î†• Î∂àÎü¨Ïò§Í∏∞
        if (roomId) {
            // GET /chatroom/{roomId}/messages - Ï±ÑÌåÖÎ∞© Î©îÏãúÏßÄ ÌûàÏä§ÌÜ†Î¶¨ Ï°∞Ìöå API Ìò∏Ï∂ú
            const res = await fetch(`${API_BASE}/chatroom/${roomId}/messages`, { credentials: 'include' });
            if (res.ok) {
                const history = await res.json();
                // Í∞Å Î©îÏãúÏßÄÎ•º Ï±ÑÌåÖ Î≤ÑÎ∏îÎ°ú ÌëúÏãú
                history.forEach(item => {
                    addChatBubble('user', item.question);
                    addChatBubble('bot', marked.parse(item.response), item.id, item.feedback_given);
                });
            }
        }

        // Î©îÏãúÏßÄ ÏûÖÎ†•Ï∞Ω Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        const input = document.querySelector('.chatbot-input-inner input');
        const sendBtn = document.querySelector('.chatbot-input-inner button');
        
        // Enter ÌÇ§Î°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
        input.onkeyup = function(e) {
            if (e.key === 'Enter') sendMessage();
        };
        
        // Ï†ÑÏÜ° Î≤ÑÌäº ÌÅ¥Î¶≠ÏúºÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
        sendBtn.onclick = sendMessage;

        // ÏòàÏãú ÏßàÎ¨∏ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        document.querySelectorAll('.example-q').forEach(el => {
            el.onclick = () => {
                input.value = el.dataset.question;
                sendMessage();
            };
        });
    });

    // Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò (Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± + Î©îÏãúÏßÄ Ï†ÑÏÜ°)
    async function sendMessage() {
        const input = document.querySelector('.chatbot-input-inner input');
        const sendBtn = document.querySelector('.chatbot-input-inner button');
        const message = input.value.trim();
        
        // Îπà Î©îÏãúÏßÄ Ï≤¥ÌÅ¨
        if (!message) return;

        // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄÎ•º Ï±ÑÌåÖ ÏòÅÏó≠Ïóê Ï¶âÏãú ÌëúÏãú
        addChatBubble('user', message);
        input.value = '';
        input.disabled = true;
        sendBtn.disabled = true;

        // Î°úÎî© Ïä§ÌîºÎÑà ÌëúÏãú
        const spinner = document.getElementById('spinner-overlay');
        spinner.style.display = 'flex';

        try {
            // 1Îã®Í≥Ñ: Ï±ÑÌåÖÎ∞©Ïù¥ ÏóÜÏúºÎ©¥ Î®ºÏ†Ä ÏÉùÏÑ± (title=Ï≤´ Î©îÏãúÏßÄ)
            if (!roomId) {
                // POST /chatroom/ - ÏÉàÎ°úÏö¥ Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± API Ìò∏Ï∂ú
                const resRoom = await fetch(`${API_BASE}/chatroom/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: message }),
                    credentials: 'include'
                });
                if (!resRoom.ok) throw new Error('Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ïã§Ìå®');
                const dataRoom = await resRoom.json();
                roomId = dataRoom.id;
                
                // 2Îã®Í≥Ñ: URLÏóê room ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä (pushStateÎ°ú ÏÉàÎ°úÍ≥†Ïπ® ÏóÜÏù¥)
                window.history.replaceState({}, '', `?room=${roomId}`);
            }
            
            // 3Îã®Í≥Ñ: Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± ÌõÑ Î©îÏãúÏßÄ Ï†ÑÏÜ°
            // POST /chat/chat - Ï±óÎ¥áÍ≥º ÎåÄÌôî API Ìò∏Ï∂ú
            const res = await fetch(`${API_BASE}/chat/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: message, chatroom_id: roomId }),
                credentials: 'include'
            });
            if (!res.ok) throw new Error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®');
            const data = await res.json();
            
            // Ï±óÎ¥á ÏùëÎãµÏùÑ Ï±ÑÌåÖ ÏòÅÏó≠Ïóê ÌëúÏãú
            addChatBubble('bot', marked.parse(data.response), data.id, false);
        } catch (err) {
            // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
            addChatBubble('bot', `‚ö†Ô∏è ÎãµÎ≥ÄÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. ${err}`);
        } finally {
            // Î°úÎî© ÏôÑÎ£å ÌõÑ UI ÏÉÅÌÉú Î≥µÏõê
            spinner.style.display = 'none';
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
    }

    // Ï±ÑÌåÖ Î≤ÑÎ∏î ÏÉùÏÑ± Î∞è Ï∂îÍ∞Ä Ìï®Ïàò
    function addChatBubble(who, text, chatId = null, feedbackGiven = false) {
        const chatArea = document.getElementById('chat-area');
        const bubbleContainer = document.createElement('div');
        bubbleContainer.className = `chat-bubble ${who}`;

        // ÌòÑÏû¨ ÏãúÍ∞Ñ ÌëúÏãú
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        const timeEl = document.createElement('span');
        timeEl.className = 'chat-time';
        timeEl.textContent = time;

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'bubble';

        // Ï§ÑÎ∞îÍøà Î≥ÄÌôò Ï∂îÍ∞Ä (Ï±óÎ¥á ÏùëÎãµÏùò Í≤ΩÏö∞)
        let htmlText = text;
        if (who === 'bot') {
            htmlText = htmlText.replace(/\n/g, '<br>');
        }
        bubbleDiv.innerHTML = htmlText;

        if (who === 'bot') {
            // Ï±óÎ¥á ÏùëÎãµ Î≤ÑÎ∏î (ÌîºÎìúÎ∞± Í∏∞Îä• Ìè¨Ìï®)
            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = 'bubble-wrapper';

            const bubbleContent = document.createElement('div');
            bubbleContent.appendChild(bubbleDiv);
            bubbleContent.style.paddingTop = '16px'; // Ï±óÎ¥á ÎãµÏû• ÏÉÅÎã® Ìå®Îî© Ï∂îÍ∞Ä
            bubbleContent.style.paddingLeft = '16px'; // Ï±óÎ¥á ÎãµÏû• Ï¢åÏ∏° Ìå®Îî© Ï∂îÍ∞Ä
            bubbleWrapper.appendChild(bubbleContent);

            // ÌîºÎìúÎ∞±Ïù¥ ÏïÑÏßÅ Ï£ºÏñ¥ÏßÄÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ÏóêÎßå ÌîºÎìúÎ∞± Î≤ÑÌäº ÌëúÏãú
            if (!feedbackGiven) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'chat-feedback';
                
                // ÏãúÍ∞ÑÍ≥º ÌîºÎìúÎ∞± Î¨∏Íµ¨Î•º Ìïú Ï§ÑÏóê, | Í∏∞Ìò∏Î°ú Íµ¨Î∂Ñ
                const feedbackRow = document.createElement('span');
                feedbackRow.style.display = 'flex';
                feedbackRow.style.alignItems = 'center';
                feedbackRow.style.gap = '8px';
                const timeClone = timeEl.cloneNode(true);
                const divider = document.createElement('span');
                divider.textContent = '|';
                divider.style.margin = '0 6px';
                const feedbackText = document.createElement('span');
                feedbackText.textContent = 'Ïù¥ ÎãµÎ≥ÄÏù¥ ÎèÑÏõÄÏù¥ ÎêòÏóàÎÇòÏöî?';
                feedbackRow.appendChild(timeClone);
                feedbackRow.appendChild(divider);
                feedbackRow.appendChild(feedbackText);
                feedbackDiv.appendChild(feedbackRow);
                
                // Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî Î≤ÑÌäº ÏÉùÏÑ±
                const likeBtn = document.createElement('button');
                likeBtn.className = 'feedback-btn';
                likeBtn.innerText = 'üëç';
                const dislikeBtn = document.createElement('button');
                dislikeBtn.className = 'feedback-btn';
                dislikeBtn.innerText = 'üëé';
                
                // ÌîºÎìúÎ∞± Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
                likeBtn.onclick = () => sendFeedback(chatId, 1, likeBtn, dislikeBtn, feedbackDiv);
                dislikeBtn.onclick = () => sendFeedback(chatId, -1, likeBtn, dislikeBtn, feedbackDiv);
                feedbackDiv.appendChild(likeBtn);
                feedbackDiv.appendChild(dislikeBtn);
                bubbleWrapper.appendChild(feedbackDiv);
            }
            bubbleContainer.appendChild(bubbleWrapper);

        } else { 
            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Î≤ÑÎ∏î
            bubbleContainer.appendChild(timeEl);
            bubbleContainer.appendChild(bubbleDiv);
        }
        
        // Ï±ÑÌåÖ ÏòÅÏó≠Ïóê Î≤ÑÎ∏î Ï∂îÍ∞Ä
        chatArea.appendChild(bubbleContainer);
        
        // Ïä§ÌÅ¨Î°§ÏùÑ ÏôÑÏ†ÑÌûà Îß® ÏïÑÎûòÎ°ú ÎÇ¥Î¶¨Í∏∞ ÏúÑÌï¥ requestAnimationFrame Îëê Î≤à ÏÇ¨Ïö©
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
            });
        });
    }

    // ÌîºÎìúÎ∞± Ï†ÑÏÜ° Ìï®Ïàò (Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî)
    async function sendFeedback(chatId, score, likeBtn, dislikeBtn, feedbackDiv) {
        try {
            // POST /feedback/feedback - Ï±óÎ¥á ÏùëÎãµÏóê ÎåÄÌïú ÌîºÎìúÎ∞± Ï†ÑÏÜ° API Ìò∏Ï∂ú
            const payload = { chat_id: chatId, score: score };
            const res = await fetch(`${API_BASE}/feedback/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include'
            });
            if (!res.ok) {
                const errorText = await res.text();
                alert('ÌîºÎìúÎ∞± Ï†ÑÏÜ° Ïã§Ìå®: ' + errorText);
                return;
            }
            // ÌîºÎìúÎ∞± ÏÑ±Í≥µ Ïãú Î≤ÑÌäºÍ≥º Î¨∏Íµ¨ Ï†úÍ±∞, Í∞êÏÇ¨ ÌåùÏóÖ
            if (feedbackDiv && feedbackDiv.parentNode) {
                feedbackDiv.parentNode.removeChild(feedbackDiv);
            }
            alert('ÌîºÎìúÎ∞± Í∞êÏÇ¨Ìï©ÎãàÎã§!');
        } catch (e) {
            alert('ÌîºÎìúÎ∞± Ï†ÑÏÜ° Ïã§Ìå®: ' + e.message);
        }
    }
    </script>
    </body>
    </html>