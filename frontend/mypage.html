<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ESG Chatbot - ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="/common/styles/reset.css">
    <link rel="stylesheet" href="/common/styles/theme.css">
    <link rel="stylesheet" href="/common/components/navbar.css">
    <style>
        body {
            background-color: #fff;
            font-family: 'Pretendard', sans-serif;
        }
        .mypage-layout { display: flex; max-width: none; margin: 0; min-height: 600px; }
        .mypage-sidebar {
            width: 260px;
            background: #fafafa;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            border-right: 1.5px solid #e5e5e5;
            min-height: 600px;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .sidebar-item {
            padding: 18px 24px;
            margin: 0 0 0 10px;
            font-size: 1em;
            border-radius: 16px;
            background: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-item.active {
            background: #e6e6e6;
            font-weight: bold;
            color: #23911C;
            border-radius: 16px;
        }
        .sidebar-item:hover {
            background: #e6e6e6;
            border-radius: 16px;
        }
        .mypage-main { flex: 1; padding: 30px 80px 60px 80px; background: none; border-radius: 0; box-shadow: none; min-width: 0; }
        .account-panel { background: none; box-shadow: none; border-radius: 0; padding: 0; }
        .account-panel h2 { font-size: 2em; font-weight: 700; margin-bottom: 24px; margin-top: 0; }
        .account-panel div { margin-bottom: 16px; }
        .account-label { display: block; font-size: 0.95em; color: #555; margin-bottom: 6px; }
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            max-width: 360px;
            padding: 10px 12px;
            font-size: 0.95em;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        input[disabled] {
            background-color: #eaeaea;
            color: #777;
        }
        button[type="submit"] {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
        }
        button[type="submit"]:hover {
            background-color: #3e9e45;
        }
        #pw-change-msg { font-size: 0.9em; font-weight: 500; }
        .history-title { font-size: 2em; font-weight: bold; margin-bottom: 32px; }
        .history-card { background: #f5f5f5; border-radius: 10px; padding: 18px 32px; margin-bottom: 18px; display: flex; align-items: center; gap: 16px; cursor: pointer; font-size: 1.15em; transition: background 0.15s; }
        .history-card:hover { background: #e0eaff; }
        .history-card .icon { font-size: 1.3em; color: #888; }
        #navbar, .navbar, nav.navbar { border-bottom: none !important; box-shadow: none !important; }
    </style>
</head>
<body>
    <div id="navbar"></div>
    <div class="mypage-layout">
        <div class="mypage-sidebar">
            <div class="sidebar-item active" id="tab-account"><span>ğŸ‘¤</span> ë‚˜ì˜ ê³„ì •</div>
            <div class="sidebar-item" id="tab-history"><span>â°</span> íˆìŠ¤í† ë¦¬</div>
        </div>
        <div class="mypage-main">
            <div id="account-panel" class="account-panel" style="display:block;">
                <h2>ë‚˜ì˜ ê³„ì •</h2>
                <div><span class="account-label">ì´ë¦„</span><input type="text" id="user-name" disabled></div>
                <div style="margin-top:10px;"><span class="account-label">ì´ë©”ì¼</span><input type="email" id="user-email" disabled></div>
                <div style="margin-top:10px;"><span class="account-label">íšŒì‚¬ëª…</span><input type="text" id="user-company" disabled></div>
                <hr style="margin:30px 0;">
                <form id="pw-change-form">
                    <div><span class="account-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</span><input type="password" id="current-password" required></div>
                    <div style="margin-top:10px;"><span class="account-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</span><input type="password" id="new-password" required></div>
                    <div style="margin-top:10px;"><span class="account-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</span><input type="password" id="new-password2" required></div>
                    <button type="submit" style="margin-top:16px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    <div id="pw-change-msg" style="margin-top:10px;"></div>
                </form>
            </div>
            <div id="history-panel" style="display:none;">
                <div class="history-title">íˆìŠ¤í† ë¦¬</div>
                <div id="chatroom-list"></div>
            </div>
        </div>
    </div>
    <script src="/common/components/navbar.js"></script>
    <script>
    // API ê¸°ë³¸ URL (ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© - Nginx í”„ë¡ì‹œë¥¼ í†µí•´ API ì„œë²„ë¡œ ì „ë‹¬)
    const API_BASE = '';
    const currentPath = encodeURIComponent(location.pathname + location.search);
    
    // ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸ - ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ (next íŒŒë¼ë¯¸í„° í¬í•¨)
    fetch(`${API_BASE}/auth/me`, { credentials: 'include' })
        .then(res => {
            if (!res.ok) location.href = `login.html?next=${currentPath}`;
            else return res.json();
        })
        .then(user => {
            if (!user) location.href = `login.html?next=${currentPath}`;
        })
        .catch(() => location.href = `login.html?next=${currentPath}`);

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜
    document.addEventListener('DOMContentLoaded', function() {
        // íƒ­ ì „í™˜ ê¸°ëŠ¥ ì„¤ì •
        const tabAccount = document.getElementById('tab-account');
        const tabHistory = document.getElementById('tab-history');
        const accountPanel = document.getElementById('account-panel');
        const historyPanel = document.getElementById('history-panel');
        
        // ê¸°ë³¸ ìƒíƒœ: ê³„ì • ì •ë³´ íƒ­ì´ ë¨¼ì € ë³´ì´ë„ë¡ ì„¤ì •
        tabAccount.classList.add('active');
        tabHistory.classList.remove('active');
        accountPanel.style.display = 'block';
        historyPanel.style.display = 'none';
        
        // ê³„ì • ì •ë³´ íƒ­ í´ë¦­ ì´ë²¤íŠ¸
        tabAccount.onclick = function() {
            tabAccount.classList.add('active');
            tabHistory.classList.remove('active');
            accountPanel.style.display = 'block';
            historyPanel.style.display = 'none';
        };
        
        // íˆìŠ¤í† ë¦¬ íƒ­ í´ë¦­ ì´ë²¤íŠ¸
        tabHistory.onclick = function() {
            tabHistory.classList.add('active');
            tabAccount.classList.remove('active');
            accountPanel.style.display = 'none';
            historyPanel.style.display = 'block';
        };

        // íˆìŠ¤í† ë¦¬(ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸) ë¶ˆëŸ¬ì˜¤ê¸°
        // GET /chatroom/list - ì‚¬ìš©ìì˜ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ API í˜¸ì¶œ
        fetch(`${API_BASE}/chatroom/list`, { credentials: 'include' })
            .then(res => res.json())
            .then(rooms => {
                const listDiv = document.getElementById('chatroom-list');
                if (!rooms.length) {
                    // ì±„íŒ…ë°©ì´ ì—†ëŠ” ê²½ìš°
                    listDiv.innerHTML = '<p>ëŒ€í™”ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    // ê° ì±„íŒ…ë°©ì„ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œ
                    rooms.forEach(room => {
                        const el = document.createElement('div');
                        el.className = 'history-card';
                        el.innerHTML = `<span class="icon">â°</span> <span>${room.title}</span>`;
                        // ì±„íŒ…ë°© í´ë¦­ ì‹œ í•´ë‹¹ ë°©ìœ¼ë¡œ ì´ë™
                        el.onclick = () => location.href = `chatbot.html?room=${room.id}`;
                        listDiv.appendChild(el);
                    });
                }
            });

        // ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        // GET /auth/me - í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ
        fetch(`${API_BASE}/auth/me`, { credentials: 'include' })
            .then(res => res.json())
            .then(user => {
                // ì‚¬ìš©ì ì •ë³´ë¥¼ í¼ í•„ë“œì— í‘œì‹œ (ì½ê¸° ì „ìš©)
                document.getElementById('user-name').value = user.name || '-';
                document.getElementById('user-email').value = user.email || '-';
                document.getElementById('user-company').value = user.company || '-';
            })
            .catch(() => {});

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.getElementById('pw-change-form').onsubmit = async function(e) {
            e.preventDefault();
            
            // í¼ ë°ì´í„° ì¶”ì¶œ
            const currentPw = document.getElementById('current-password').value;
            const newPw = document.getElementById('new-password').value;
            const newPw2 = document.getElementById('new-password2').value;
            const msgDiv = document.getElementById('pw-change-msg');
            msgDiv.textContent = '';
            msgDiv.style.color = '';
            
            // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
            if (newPw !== newPw2) {
                msgDiv.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                msgDiv.style.color = '#e74c3c';
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
            if (newPw.length < 8) {
                msgDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                msgDiv.style.color = '#e74c3c';
                return;
            }
            
            // ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ í¬í•¨ í™•ì¸
            const hasLetter = /[a-zA-Z]/.test(newPw);
            const hasNumber = /[0-9]/.test(newPw);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPw);
            
            const criteriaCount = [hasLetter, hasNumber, hasSpecial].filter(Boolean).length;
            
            if (criteriaCount < 2) {
                msgDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
                msgDiv.style.color = '#e74c3c';
                return;
            }
            
            try {
                // POST /auth/change-password - ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API í˜¸ì¶œ
                const res = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPw,
                        new_password: newPw
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ ì‹œ ì²˜ë¦¬
                    msgDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    msgDiv.style.color = '#27ae60';
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('new-password2').value = '';
                } else {
                    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    msgDiv.textContent = data.detail || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨';
                    msgDiv.style.color = '#e74c3c';
                }
            } catch (err) {
                // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“± ì˜ˆì™¸ ì²˜ë¦¬
                msgDiv.textContent = 'ì—ëŸ¬: ' + err;
                msgDiv.style.color = '#e74c3c';
            }
        };
    });
    </script>
</body>
</html> 